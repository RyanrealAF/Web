<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychological Warfare Analysis Visualization</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; script-src 'self' 'unsafe-inline' https://esm.sh;">
    <style>
        body {
            background-color: #1a1a1a;
            /* Concrete texture approximation */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            overflow-y: auto;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 6px;
            border: 3px solid #2a2a2a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        #root {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "d3": "https://esm.sh/d3@7.8.5"
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as d3 from 'd3';

        const App = () => {
            const svgRef = useRef(null);
            const [data, setData] = React.useState(null);
            const [error, setError] = React.useState(null);

            useEffect(() => {
                // Fetch the raw text file containing the threat model
                fetch('./Database/raw/The game now seen Final.txt')
                    .then(response => {
                        if (!response.ok) throw new Error("Failed to load data file");
                        return response.text();
                    })
                    .then(text => {
                        const nodes = [];
                        const lines = text.split(/\r?\n/);
                        // Regex to match 1.2.1, 1.2.2, 1.2.3 headers
                        const nodePattern = /^\s*1\.2\.[1-3]\s+(.+)/;
                        
                        lines.forEach(line => {
                            const match = line.match(nodePattern);
                            if (match) {
                                nodes.push({ id: match[1].trim() });
                            }
                        });

                        // Create links based on the hierarchy (Orchestrator -> Agents)
                        const links = [];
                        if (nodes.length >= 3) {
                            // Assuming order: Orchestrator, Access Agent, Unwitting Operative
                            const orchestrator = nodes.find(n => n.id.includes("Orchestrator"));
                            const accessAgent = nodes.find(n => n.id.includes("Access Agent"));
                            const unwitting = nodes.find(n => n.id.includes("Unwitting Operative"));

                            if (orchestrator && accessAgent) links.push({ source: orchestrator.id, target: accessAgent.id });
                            if (orchestrator && unwitting) links.push({ source: orchestrator.id, target: unwitting.id });
                            if (accessAgent && unwitting) links.push({ source: accessAgent.id, target: unwitting.id });
                        }

                        setData({ nodes, links });
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                    });
            }, []);

            useEffect(() => {
                if (!data || !svgRef.current) return;

                const width = 800;
                const height = 600;
                const svg = d3.select(svgRef.current)
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", [-width / 2, -height / 2, width, height])
                    .style("background", "rgba(0, 0, 0, 0.3)")
                    .style("border-radius", "8px")
                    .style("box-shadow", "0 4px 6px rgba(0,0,0,0.3)");

                svg.selectAll("*").remove();

                const simulation = d3.forceSimulation(data.nodes)
                    .force("link", d3.forceLink(data.links).id(d => d.id).distance(200))
                    .force("charge", d3.forceManyBody().strength(-1000))
                    .force("center", d3.forceCenter(0, 0));

                const link = svg.append("g")
                    .attr("stroke", "#999")
                    .attr("stroke-opacity", 0.6)
                    .selectAll("line")
                    .data(data.links)
                    .join("line")
                    .attr("stroke-width", 2);

                const node = svg.append("g")
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .selectAll("circle")
                    .data(data.nodes)
                    .join("circle")
                    .attr("r", 20)
                    .attr("fill", d => d.id.includes("Orchestrator") ? "#ff5252" : "#4caf50")
                    .call(d3.drag()
                        .on("start", (event, d) => {
                            if (!event.active) simulation.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                        })
                        .on("drag", (event, d) => {
                            d.fx = event.x;
                            d.fy = event.y;
                        })
                        .on("end", (event, d) => {
                            if (!event.active) simulation.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                        }));

                const label = svg.append("g")
                    .selectAll("text")
                    .data(data.nodes)
                    .join("text")
                    .attr("dy", -25)
                    .attr("text-anchor", "middle")
                    .text(d => d.id)
                    .attr("fill", "#e0e0e0")
                    .style("font-size", "14px")
                    .style("pointer-events", "none")
                    .style("text-shadow", "0 1px 2px black");

                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    label
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });
            }, [data]);

            return React.createElement(
                'div',
                { style: { textAlign: 'center' } },
                React.createElement('h1', null, 'Asymmetric Threat Model Visualization'),
                error 
                    ? React.createElement('div', { style: { color: '#ff5252', maxWidth: '600px', margin: '0 auto' } }, 
                        React.createElement('p', null, `Error loading data: ${error}`),
                        React.createElement('p', { style: { fontSize: '0.9em', color: '#aaa' } }, 'Note: To load local files, this HTML file must be served via a local web server (e.g., "npx http-server" or "python -m http.server"). Direct file:// access is blocked by browser security.')
                      )
                    : !data 
                        ? React.createElement('p', null, 'Parsing threat model data...')
                        : React.createElement('div', null,
                            React.createElement('p', null, `Visualizing ${data.nodes.length} active nodes`),
                            React.createElement('svg', { ref: svgRef })
                          )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>